package prometheus

import (
	"fmt"

	"github.com/kuoss/venti/pkg/mocker"
)

func New() (*mocker.Server, error) {
	s := NewWithPort(0)
	if err := s.Start(); err != nil {
		return nil, fmt.Errorf("start err: %w", err)
	}
	return s, nil
}

func NewWithPort(port int) *mocker.Server {
	s := mocker.NewWithPort(port)
	s.GET("/api/v1/status/buildinfo", handleBuildInfo)
	s.GET("/api/v1/metadata", handleMetadata)
	s.GET("/api/v1/query", handleQuery)
	s.GET("/api/v1/query_range", handleQueryRange)
	return s
}

func handleBuildInfo(c *mocker.Context) {
	c.JSONString(200, `{"status":"success","data":{"version":"2.41.0-prometheus","revision":"c0d8a56c69014279464c0e15d8bfb0e153af0dab","branch":"HEAD","buildUser":"root@d20a03e77067","buildDate":"20221220-10:40:45","goVersion":"go1.19.4"}}`)
}

func handleMetadata(c *mocker.Context) {
	c.JSONString(200, `{"status":"success","data":{"apiserver_audit_event_total":[{"type":"counter","help":"[ALPHA] Counter of audit events generated and sent to the audit backend.","unit":""}]}}`)
}

func handleQuery(c *mocker.Context) {
	query := c.Query("query")

	// 405
	if query == "" {
		c.JSONString(405, `{"status":"error","errorType":"bad_data","error":"invalid parameter \"query\": 1:1: parse error: no expression found in input"}`)
		return
	}

	// 200
	if query == "up" {
		c.JSONString(200, `{"status":"success","data":{"resultType":"vector","result":[{"metric":{"__name__":"up","job":"prometheus","instance":"localhost:9090"},"value":[1435781451.781,"1"]},{"metric":{"__name__":"up","job":"prometheus2","instance2":"localhost:9092"},"value":[1435781451.781,"1"]}]}}`)
		return
	}
	// 200
	if query == "unmarshalable" {
		c.JSONString(200, `{"status":"success","data":{"a":"b":"c"}}`)
		return
	}
	// 200 metric_not_exists
	c.JSONString(200, `{"status":"success","data":{"resultType":"vector","result":[]}}`)
}

func handleQueryRange(c *mocker.Context) {
	query := c.Query("query")
	start := c.Query("start")
	end := c.Query("end")
	step := c.Query("step")

	// 405
	if start == "" {
		c.JSONString(405, `{"status":"error","errorType":"bad_data","error":"invalid parameter \"start\": cannot parse \"\" to a valid timestamp"}`)
		return
	}
	if end == "" {
		c.JSONString(405, `{"status":"error","errorType":"bad_data","error":"invalid parameter \"end\": cannot parse \"\" to a valid timestamp"}`)
		return
	}
	if step == "" {
		c.JSONString(405, `{"status":"error","errorType":"bad_data","error":"invalid parameter \"step\": cannot parse \"\" to a valid duration"}`)
		return
	}
	if query == "" {
		c.JSONString(405, `{"status":"error","errorType":"bad_data","error":"1:1: parse error: no expression found in input"}`)
		return
	}

	// 200
	if query == "up" {
		c.JSONString(200, `{"status":"success","data":{"resultType":"matrix","result":[{"metric":{"__name__":"up","job":"prometheus","instance":"localhost:9090"},"values":[[1435781430.781,"1"],[1435781445.781,"1"],[1435781460.781,"1"]]}]}}`)
		return
	}
	if query == "hello" {
		c.JSONString(200, `{"status":"success","data":{"resultType":"matrix","result":[{"metric":{"__name__":"hello","beta_kubernetes_io_arch":"amd64","beta_kubernetes_io_os":"linux","container":"mycontainer","id":"id1","job":"kubernetes-nodes-cadvisor","kubernetes_io_arch":"amd64","kubernetes_io_os":"linux","name":"name1","namespace":"mynamespace","pod":"pod1"},"values":[[1712279569.301,"432816128"],[1712279572.301,"432816128"],[1712279575.301,"432816128"],[1712279578.301,"432816128"],[1712279581.301,"432816128"],[1712279584.301,"432816128"],[1712279587.301,"432816128"],[1712279590.301,"432816128"],[1712279593.301,"432816128"],[1712279596.301,"432816128"],[1712279599.301,"432816128"],[1712279602.301,"432816128"],[1712279605.301,"432816128"],[1712279608.301,"432816128"],[1712279611.301,"432816128"],[1712279614.301,"432816128"],[1712279617.301,"432816128"],[1712279620.301,"432816128"],[1712279623.301,"432816128"],[1712279626.301,"432816128"],[1712279629.301,"432816128"],[1712279632.301,"432816128"],[1712279635.301,"432816128"],[1712279638.301,"432816128"],[1712279641.301,"432816128"],[1712279644.301,"432816128"],[1712279647.301,"432816128"],[1712279650.301,"432816128"],[1712279653.301,"432816128"],[1712279656.301,"432816128"],[1712279659.301,"432816128"],[1712279662.301,"432816128"],[1712279665.301,"432816128"],[1712279668.301,"432816128"],[1712279671.301,"432816128"],[1712279674.301,"432816128"],[1712279677.301,"432816128"],[1712279680.301,"432816128"],[1712279683.301,"432816128"],[1712279686.301,"432816128"],[1712279689.301,"432816128"],[1712279692.301,"432816128"],[1712279695.301,"432816128"],[1712279698.301,"432816128"],[1712279701.301,"432816128"],[1712279704.301,"432816128"],[1712279707.301,"432816128"],[1712279710.301,"432816128"],[1712279713.301,"432816128"],[1712279716.301,"432816128"],[1712279719.301,"432816128"],[1712279722.301,"432816128"],[1712279725.301,"432816128"],[1712279728.301,"432816128"],[1712279731.301,"432816128"],[1712279734.301,"432816128"],[1712279737.301,"432816128"],[1712279740.301,"432816128"],[1712279743.301,"432816128"],[1712279746.301,"432816128"],[1712279749.301,"432816128"],[1712279752.301,"432816128"],[1712279755.301,"432816128"],[1712279758.301,"432816128"],[1712279761.301,"432816128"],[1712279764.301,"432816128"],[1712279767.301,"432816128"],[1712279770.301,"432816128"],[1712279773.301,"432816128"],[1712279776.301,"432816128"],[1712279779.301,"432816128"],[1712279782.301,"432816128"],[1712279785.301,"432816128"],[1712279788.301,"432816128"],[1712279791.301,"432816128"],[1712279794.301,"432816128"],[1712279797.301,"432816128"],[1712279800.301,"432816128"],[1712279803.301,"432816128"],[1712279806.301,"432816128"],[1712279809.301,"432816128"],[1712279812.301,"432816128"],[1712279815.301,"432816128"],[1712279818.301,"432816128"],[1712279821.301,"432816128"],[1712279824.301,"432816128"],[1712279827.301,"432816128"],[1712279830.301,"609775616"],[1712279833.301,"609775616"],[1712279836.301,"609775616"],[1712279839.301,"609775616"],[1712279842.301,"609775616"],[1712279845.301,"609775616"],[1712279848.301,"609775616"],[1712279851.301,"609775616"],[1712279854.301,"609775616"],[1712279857.301,"609775616"],[1712279860.301,"609775616"],[1712279863.301,"609775616"],[1712279866.301,"609775616"],[1712279869.301,"609775616"],[1712279872.301,"609775616"],[1712279875.301,"609775616"],[1712279878.301,"609775616"],[1712279881.301,"609775616"],[1712279884.301,"609775616"],[1712279887.301,"609775616"],[1712279890.301,"629145600"],[1712279893.301,"629145600"],[1712279896.301,"629145600"],[1712279899.301,"629145600"],[1712279902.301,"629145600"],[1712279905.301,"629145600"],[1712279908.301,"629145600"],[1712279911.301,"629145600"],[1712279914.301,"629145600"],[1712279917.301,"629145600"],[1712279920.301,"629145600"],[1712279923.301,"629145600"],[1712279926.301,"629145600"],[1712279929.301,"629145600"],[1712279932.301,"629145600"],[1712279935.301,"629145600"],[1712279938.301,"629145600"],[1712279941.301,"629145600"],[1712279944.301,"629145600"],[1712279947.301,"629145600"],[1712279950.301,"629145600"],[1712279953.301,"629145600"],[1712279956.301,"629145600"],[1712279959.301,"629145600"],[1712279962.301,"629145600"],[1712279965.301,"629145600"],[1712279968.301,"629145600"],[1712279971.301,"629145600"],[1712279974.301,"629145600"],[1712279977.301,"629145600"],[1712279980.301,"629145600"],[1712279983.301,"629145600"],[1712279986.301,"629145600"],[1712279989.301,"629145600"],[1712279992.301,"629145600"],[1712279995.301,"629145600"],[1712279998.301,"629145600"],[1712280001.301,"629145600"],[1712280004.301,"629145600"],[1712280007.301,"629145600"],[1712280010.301,"629145600"],[1712280013.301,"629145600"],[1712280016.301,"629145600"],[1712280019.301,"629145600"],[1712280022.301,"629145600"],[1712280025.301,"629145600"],[1712280028.301,"629145600"],[1712280031.301,"629145600"],[1712280034.301,"629145600"],[1712280037.301,"629145600"],[1712280040.301,"629145600"],[1712280043.301,"629145600"],[1712280046.301,"629145600"],[1712280049.301,"629145600"],[1712280052.301,"629145600"],[1712280055.301,"629145600"],[1712280058.301,"629145600"],[1712280061.301,"629145600"],[1712280064.301,"629145600"],[1712280067.301,"629145600"],[1712280070.301,"629145600"],[1712280073.301,"629145600"],[1712280076.301,"629145600"],[1712280079.301,"629145600"],[1712280082.301,"629145600"],[1712280085.301,"629145600"],[1712280088.301,"629145600"],[1712280091.301,"629145600"],[1712280094.301,"629145600"],[1712280097.301,"629145600"],[1712280100.301,"629145600"],[1712280103.301,"629145600"],[1712280106.301,"629145600"],[1712280109.301,"629145600"],[1712280112.301,"629145600"],[1712280115.301,"629145600"],[1712280118.301,"629145600"],[1712280121.301,"629145600"],[1712280124.301,"629145600"],[1712280127.301,"629145600"],[1712280130.301,"629145600"],[1712280133.301,"629145600"],[1712280136.301,"629145600"],[1712280139.301,"629145600"],[1712280142.301,"629145600"],[1712280145.301,"629145600"],[1712280148.301,"629145600"],[1712280151.301,"629145600"],[1712280154.301,"629145600"],[1712280157.301,"629145600"],[1712280160.301,"629145600"],[1712280163.301,"629145600"],[1712280166.301,"629145600"],[1712280169.301,"629145600"],[1712280172.301,"629145600"],[1712280175.301,"629145600"],[1712280178.301,"629145600"],[1712280181.301,"629145600"],[1712280184.301,"629145600"],[1712280187.301,"629145600"]]},{"metric":{"__name__":"hello","beta_kubernetes_io_arch":"amd64","beta_kubernetes_io_os":"linux","container":"mycontainer","id":"id2","job":"kubernetes-nodes-cadvisor","kubernetes_io_arch":"amd64","kubernetes_io_os":"linux","name":"name2","namespace":"mynamespace","pod":"pod2"},"values":[[1712279941.301,"367230976"],[1712279944.301,"367230976"],[1712279947.301,"367230976"],[1712279950.301,"367230976"],[1712279953.301,"367230976"],[1712279956.301,"367230976"],[1712279959.301,"367230976"],[1712279962.301,"367230976"],[1712279965.301,"367230976"],[1712279968.301,"367230976"],[1712279971.301,"367230976"],[1712279974.301,"367230976"],[1712279977.301,"367230976"],[1712279980.301,"367230976"],[1712279983.301,"367230976"],[1712279986.301,"367230976"],[1712279989.301,"367230976"],[1712279992.301,"367230976"],[1712279995.301,"367230976"],[1712279998.301,"367230976"],[1712280001.301,"367230976"],[1712280004.301,"367230976"],[1712280007.301,"367230976"],[1712280010.301,"379637760"],[1712280013.301,"379637760"],[1712280016.301,"379637760"],[1712280019.301,"379637760"],[1712280022.301,"379637760"],[1712280025.301,"379637760"],[1712280028.301,"379637760"],[1712280031.301,"379637760"],[1712280034.301,"379637760"],[1712280037.301,"379637760"],[1712280040.301,"379637760"],[1712280043.301,"379637760"],[1712280046.301,"379637760"],[1712280049.301,"379637760"],[1712280052.301,"379637760"],[1712280055.301,"379637760"],[1712280058.301,"379637760"],[1712280061.301,"379637760"],[1712280064.301,"379637760"],[1712280067.301,"379637760"],[1712280070.301,"379637760"],[1712280073.301,"361123840"],[1712280076.301,"361123840"],[1712280079.301,"361123840"],[1712280082.301,"361123840"],[1712280085.301,"361123840"],[1712280088.301,"361123840"],[1712280091.301,"361123840"],[1712280094.301,"361123840"],[1712280097.301,"361123840"],[1712280100.301,"361123840"],[1712280103.301,"361123840"],[1712280106.301,"361123840"],[1712280109.301,"361123840"],[1712280112.301,"361123840"],[1712280115.301,"361123840"],[1712280118.301,"361123840"],[1712280121.301,"361123840"],[1712280124.301,"361123840"],[1712280127.301,"361795584"],[1712280130.301,"361795584"],[1712280133.301,"361795584"],[1712280136.301,"361795584"],[1712280139.301,"361795584"],[1712280142.301,"361795584"],[1712280145.301,"361795584"],[1712280148.301,"361795584"],[1712280151.301,"361795584"],[1712280154.301,"361795584"],[1712280157.301,"361795584"],[1712280160.301,"361795584"],[1712280163.301,"361795584"],[1712280166.301,"361795584"],[1712280169.301,"361795584"],[1712280172.301,"361795584"],[1712280175.301,"361795584"],[1712280178.301,"361795584"],[1712280181.301,"361795584"],[1712280184.301,"361795584"],[1712280187.301,"361795584"],[1712280190.301,"361795584"],[1712280193.301,"298815488"],[1712280196.301,"298815488"],[1712280199.301,"298815488"],[1712280202.301,"298815488"],[1712280205.301,"298815488"],[1712280208.301,"298815488"],[1712280211.301,"298815488"],[1712280214.301,"298815488"],[1712280217.301,"298815488"],[1712280220.301,"298815488"],[1712280223.301,"298815488"],[1712280226.301,"298815488"],[1712280229.301,"298815488"],[1712280232.301,"298815488"],[1712280235.301,"298815488"],[1712280238.301,"298815488"],[1712280241.301,"298815488"],[1712280244.301,"298815488"],[1712280247.301,"298815488"],[1712280250.301,"298815488"],[1712280253.301,"298815488"],[1712280256.301,"298860544"],[1712280259.301,"298860544"],[1712280262.301,"298860544"],[1712280265.301,"298860544"],[1712280268.301,"298860544"],[1712280271.301,"298860544"],[1712280274.301,"298860544"],[1712280277.301,"298860544"],[1712280280.301,"298860544"],[1712280283.301,"298860544"],[1712280286.301,"298860544"],[1712280289.301,"298860544"],[1712280292.301,"298860544"],[1712280295.301,"298860544"],[1712280298.301,"298860544"],[1712280301.301,"298860544"],[1712280304.301,"299106304"],[1712280307.301,"299106304"],[1712280310.301,"299106304"],[1712280313.301,"299106304"],[1712280316.301,"299106304"],[1712280319.301,"299106304"],[1712280322.301,"299106304"],[1712280325.301,"299106304"],[1712280328.301,"299106304"],[1712280331.301,"299106304"],[1712280334.301,"299106304"],[1712280337.301,"299106304"],[1712280340.301,"299106304"],[1712280343.301,"299106304"],[1712280346.301,"299106304"],[1712280349.301,"299106304"],[1712280352.301,"299106304"],[1712280355.301,"299106304"],[1712280358.301,"299106304"],[1712280361.301,"299106304"],[1712280364.301,"299106304"],[1712280367.301,"299106304"],[1712280370.301,"299286528"],[1712280373.301,"299286528"],[1712280376.301,"299286528"],[1712280379.301,"299286528"],[1712280382.301,"299286528"],[1712280385.301,"299286528"],[1712280388.301,"299286528"],[1712280391.301,"299286528"],[1712280394.301,"299286528"],[1712280397.301,"299286528"],[1712280400.301,"299286528"],[1712280403.301,"299286528"],[1712280406.301,"299286528"],[1712280409.301,"299286528"],[1712280412.301,"299286528"],[1712280415.301,"299286528"],[1712280418.301,"299286528"],[1712280421.301,"299286528"],[1712280424.301,"299286528"],[1712280427.301,"299286528"],[1712280430.301,"299184128"],[1712280433.301,"299184128"],[1712280436.301,"299184128"],[1712280439.301,"299184128"],[1712280442.301,"299184128"],[1712280445.301,"299184128"]]}]}}`)
		return
	}
	// 200 metric_not_exists
	c.JSONString(200, `{"status":"success","data":{"resultType":"matrix","result":[]}}`)
}
